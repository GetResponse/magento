<div class="getresponse-tracking-code-section" data-bind="scope: 'getresponse_tracking_code_section'">
    <div id="customer-email-address" data-bind="attr: { 'customer-email': getResponseTrackingCode().customerEmail }"></div>
    <div id="tracking-code-events" data-bind="attr: { 'cart': getResponseTrackingCode().cart }"></div>
</div>

<script>
    require([
        'jquery',
        'mage/cookies',
        'Magento_Customer/js/customer-data'
    ], function ($) {

        $('body').on('DOMSubtreeModified', '#customer-email-address', function (customerData) {

            var customerEmail = document.getElementById('customer-email-address').getAttribute('customer-email');
            var gaIsValuable = $.cookie('gaIsValuable');
            var trackingCodeEnabled = typeof gaSetUserId !== 'undefined' && typeof gaSetUserId === 'function';

            if (customerEmail !== null && trackingCodeEnabled && gaIsValuable !== '1') {
                gaSetUserId(customerEmail);
            }
        });

        $('body').on('DOMSubtreeModified', '#tracking-code-events', function () {

            var rawCart = document.getElementById('tracking-code-events').getAttribute('cart');

            if (rawCart === null) {
                return;
            }

            var trackingCodeEnabled = typeof gaSetUserId !== 'undefined' && typeof gaSetUserId === 'function';

            var cart = JSON.parse(rawCart);

            if (Object.keys(cart).length !== 0 && trackingCodeEnabled) {

                GrTracking('importScript', 'ec');
                GrTracking('cartUpdate', cart);
                customerData.reload(['getresponse-tracking-code']);
            }
        });

        $(document).ready(function() {

            if (typeof GrViewCategoryItem !== 'undefined') {
                GrTracking('importScript', 'ec');
                GrTracking('viewCategory', GrViewCategoryItem);
            }

            if (typeof GrViewProductItem !== 'undefined') {
                GrTracking('importScript', 'ec');
                GrTracking('viewItem', GrViewProductItem);
            }
        });
    });
</script>

<script type="text/x-magento-init">
    {
        "*": {
            "Magento_Ui/js/core/app": {
                "components": {
                    "getresponse_tracking_code_section": {
                        "component": "GetResponse_GetResponseIntegration/js/getresponse_tracking_code_section"
                    }
                }
            }
        }
    }
</script>
